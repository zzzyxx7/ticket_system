<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ticket.mapper.EventMapper">

    <resultMap id="EventResultMap" type="com.ticket.entity.Event">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="city" column="city"/>
        <result property="category" column="category"/>
        <result property="venue" column="venue"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="price" column="price"/>
        <result property="stock" column="stock"/>
        <result property="status" column="status"/>
        <result property="ticketGrade" column="ticket_grade"/>
        <result property="createdTime" column="created_time"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedBy" column="updated_by"/>
        <result property="updatedTime" column="updated_time"/>
    </resultMap>

    <!-- 基础CRUD SQL -->
    <select id="selectById" parameterType="Long" resultMap="EventResultMap">
        SELECT * FROM event WHERE id = #{id}
    </select>

    <select id="selectAll" resultMap="EventResultMap">
        SELECT * FROM event
    </select>

    <insert id="insert" parameterType="com.ticket.entity.Event"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO event (name, description, city, category, venue,
                           start_time, end_time, price, stock, status,ticket_grade,created_by,created_time)
        VALUES (#{name}, #{description}, #{city}, #{category}, #{venue},
                #{startTime}, #{endTime}, #{price}, #{stock}, #{status}, #{ticketGrade},#{createdBy},#{createdTime})
    </insert>
    <update id="update" parameterType="com.ticket.entity.Event">
        UPDATE event
        SET name = #{name}, description = #{description}, city = #{city},
            category = #{category}, venue = #{venue}, start_time = #{startTime},
            end_time = #{endTime}, price = #{price}, stock = #{stock},
            status = #{status},ticket_grade = #{ticketGrade}, updated_by = #{updatedBy},updated_time = #{updatedTime}
        WHERE id = #{id}
    </update>

    <!-- 条件查询 SQL -->
    <select id="selectByCity" parameterType="String" resultMap="EventResultMap">
        SELECT * FROM event WHERE city = #{city}
    </select>

    <select id="selectByCategory" parameterType="String" resultMap="EventResultMap">
        SELECT * FROM event WHERE category = #{category}
    </select>

    <select id="selectByCityAndCategory" resultMap="EventResultMap">
        SELECT * FROM event
        WHERE city = #{city} AND category = #{category}
    </select>

    <!-- 搜索 SQL -->
    <select id="searchByName" resultMap="EventResultMap">
        SELECT * FROM event
        WHERE name LIKE CONCAT('%', #{keyword}, '%')
    </select>
    <delete id="deleteById" parameterType="Long">
        DELETE FROM event WHERE id = #{id}
    </delete>

    <select id="countEvents" resultType="Long">
        SELECT COUNT(*) FROM event
    </select>

    <select id="selectByPage" resultMap="EventResultMap">
        SELECT * FROM event
        ORDER BY created_time DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="selectByCondition" resultMap="EventResultMap">
        SELECT * FROM event
        WHERE 1=1
        <if test="city != null and city != ''">
            AND city = #{city}
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        ORDER BY created_time DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="countByCondition" resultType="Long">
        SELECT COUNT(*) FROM event
        WHERE 1=1
        <if test="city != null and city != ''">
            AND city = #{city}
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
    </select>

    <update id="decreaseStock">
        UPDATE event
        SET stock = stock - #{quantity}
        WHERE id = #{eventId}
          AND stock >= #{quantity}
    </update>

</mapper>